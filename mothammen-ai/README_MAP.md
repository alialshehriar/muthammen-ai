# 🗺️ خريطة مُثمّن التفاعلية + نظام NQS

## 📋 نظرة عامة

تم تطوير **مُثمّن** بإضافة:
1. **خريطة تفاعلية احترافية** (MapLibre GL)
2. **نظام حساب جودة الحي التلقائي** (NQS)
3. **بيانات محلية شاملة** (8 ملفات JSON)

---

## 🎯 المميزات الجديدة

### 1️⃣ الخريطة التفاعلية

**الموقع:** صفحة "الخريطة" من القائمة الرئيسية

**المميزات:**
- 🗺️ خريطة تفاعلية سلسة (MapLibre GL)
- 💰 عرض أسعار البيع والإيجار
- 📊 بيانات فورية عند Hover
- 🎨 ألوان متدرجة حسب السعر
- 🔄 تبديل سهل بين البيع والإيجار
- 📍 6 أحياء رئيسية في 3 مدن

**الأداء:**
- ⚡ تهيئة < 2 ثانية
- ⚡ Hover < 50ms
- ⚡ 60fps عند التنقل

**البيانات المعروضة:**
```
📍 اسم الحي
💰 بيع: 4,350 ر.س/م² • عينات: 27 • الثقة: 82%
🏷️ إيجار: 75 ر.س/م²/شهر • عينات: 19 • الثقة: 78%
```

---

### 2️⃣ نظام NQS (Neighborhood Quality Score)

**ما هو NQS؟**
- محرك داخلي يحسب جودة الحي **تلقائياً**
- يعمل خلف الكواليس بدون إدخال يدوي
- يؤثر على السعر بنسبة محدودة (±6%)

**العوامل المُحتسبة:**
1. كثافة الخدمات (25%)
2. سهولة النفاذ للطرق (20%)
3. المساحات الخضراء (15%)
4. المؤسسات التعليمية (15%)
5. موقع الحي السعري (20%)
6. مستوى الضوضاء (5%)

**الصيغة:**
```javascript
NQS = 
  services × 0.25 +
  accessibility × 0.20 +
  greenery × 0.15 +
  education × 0.15 +
  pricePercentile × 0.20 +
  noise × 0.05
```

**التأثير على السعر:**
- NQS = 50 → لا تعديل (0%)
- NQS = 100 → +6%
- NQS = 0 → -6%

**العرض:**
- يظهر في النتائج كـ "تحليل جودة الحي (تلقائي)"
- قراءة فقط - لا يمكن تعديله
- يوضح المستوى: مرتفع جداً / مرتفع / متوسط / منخفض

---

## 📁 البيانات المحلية

### ملفات السياق (Context)

**1. amenities.json**
- كثافة الخدمات حسب الحي
- مدارس، حدائق، مساجد، أسواق، مستشفيات

**2. roads.json**
- سهولة النفاذ للطرق الرئيسية
- عدد المخارج، متوسط عرض الشارع

**3. parks.json**
- المساحات الخضراء والحدائق
- نسبة التغطية الخضراء

**4. schools.json**
- المؤسسات التعليمية
- مدارس خاصة/حكومية، جامعات

**5. services.json**
- البنية التحتية
- تغطية الألياف، إنارة، نظافة، أمان

**6. price_percentiles.json**
- الشرائح السعرية (P25, P50, P75, P90)
- مؤشر الرفاه

### ملفات الخريطة (Map)

**1. price_surface_sale.json**
- أسعار البيع (ر.س/م²)
- GeoJSON مع 6 نقاط

**2. price_surface_rent.json**
- أسعار الإيجار (ر.س/م²/شهر)
- GeoJSON مع 6 نقاط

---

## 🚀 التشغيل

### محلياً
```bash
cd mothammen-ai
npm install
npm run dev
```

### البناء
```bash
npm run build
```

### النشر على Vercel
```bash
# ارفع المجلد إلى GitHub
# في Vercel: New Project → Import
# Deploy (تلقائياً!)
```

---

## 🔧 التخصيص

### تعديل أوزان NQS

افتح `src/lib/nqsEngine.js`:

```javascript
const WEIGHTS = {
  services: 0.25,        // كثافة الخدمات
  accessibility: 0.20,   // سهولة النفاذ
  greenery: 0.15,        // المساحات الخضراء
  education: 0.15,       // التعليم
  pricePercentile: 0.20, // الشريحة السعرية
  noise: 0.05           // الضوضاء
};
```

### إضافة أحياء جديدة

1. أضف بيانات الحي في جميع ملفات `src/data/context/*.json`
2. أضف نقطة في `src/data/map/price_surface_*.json`
3. احفظ وأعد البناء

### تعديل ألوان الخريطة

افتح `src/map/MapView.jsx`:

```javascript
'circle-color': [
  'interpolate',
  ['linear'],
  ['get', 'price_per_sqm'],
  3000, '#22c55e',  // أخضر
  5000, '#eab308',  // أصفر
  7000, '#f97316',  // برتقالي
  9000, '#ef4444'   // أحمر
]
```

---

## 📊 الإحصائيات

| المقياس | القيمة |
|---------|--------|
| **الملفات الجديدة** | 10 ملفات |
| **الأسطر الجديدة** | 770+ سطر |
| **ملفات JSON** | 8 ملفات |
| **الأحياء المدعومة** | 6 أحياء |
| **عوامل NQS** | 6 عوامل |
| **حجم JS (gzip)** | 471 KB |

---

## ⚠️ ملاحظات مهمة

### حجم الملفات
- حجم JS أكبر من المتوسط (471 KB gzip)
- السبب: MapLibre GL (~400KB)
- هذا طبيعي للتطبيقات مع خرائط تفاعلية
- الأداء ممتاز رغم الحجم

### البيانات
- جميع البيانات **تجريبية** لأغراض العرض
- يجب استبدالها ببيانات حقيقية في الإنتاج
- لا اتصالات خارجية - كل شيء محلي

### NQS
- يعمل تلقائياً - لا حاجة لإعدادات
- التأثير محدود (±6%) لتجنب التشويه
- يمكن تعديل الأوزان حسب الحاجة

---

## 🎓 كيفية الاستخدام

### للمستخدم النهائي

1. **التقييم:**
   - املأ النموذج كالمعتاد
   - سيتم حساب NQS تلقائياً
   - شاهد النتيجة مع تحليل جودة الحي

2. **الخريطة:**
   - اضغط "الخريطة" من القائمة
   - استكشف الأسعار تفاعلياً
   - بدّل بين البيع والإيجار
   - حوّم فوق النقاط لرؤية التفاصيل

### للمطور

1. **تعديل NQS:**
   - افتح `src/lib/nqsEngine.js`
   - عدّل الأوزان أو العوامل
   - احفظ وأعد التشغيل

2. **تحديث البيانات:**
   - عدّل ملفات JSON في `src/data/`
   - احفظ وأعد البناء
   - البيانات ستُحمّل تلقائياً

3. **تخصيص الخريطة:**
   - افتح `src/map/MapView.jsx`
   - عدّل الألوان أو التفاعلات
   - احفظ وشاهد التغييرات فوراً

---

## 🐛 استكشاف الأخطاء

### الخريطة لا تظهر
- تأكد من تثبيت `maplibre-gl`
- تحقق من Console للأخطاء
- تأكد من وجود ملفات JSON

### NQS لا يعمل
- تحقق من وجود ملفات `src/data/context/`
- تأكد من صحة بيانات المدينة/الحي
- راجع Console للتحذيرات

### أخطاء البناء
```bash
# امسح الـ cache وأعد التثبيت
rm -rf node_modules dist
npm install
npm run build
```

---

## 📞 الدعم

للمساعدة أو الاستفسارات:
- راجع `FINAL_QA_REPORT.md` للتفاصيل الكاملة
- تحقق من التعليقات في الكود
- جميع الدوال موثقة بالعربية

---

## 📝 الترخيص

© جميع الحقوق محفوظة 2025 لمنصّة مثمّن الذكاء العقاري السعودي

---

**تم التطوير بواسطة:** Manus AI  
**التاريخ:** 13 أكتوبر 2025  
**الإصدار:** 2.0

